name: Manual Scraping

on:
  workflow_dispatch:
    inputs:
      site:
        description: 'Site to scrape'
        required: true
        type: choice
        options:
          - fora
          - novus
          - all
      max_pages:
        description: 'Maximum pages to scrape (0 = no limit)'
        required: false
        type: string
        default: '0'

jobs:
  scrape:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run Fora scraper
        if: ${{ inputs.site == 'fora' || inputs.site == 'all' }}
        run: |
          mkdir -p data
          python scripts/run_scraper.py --site fora --db data/listings.db --max-pages ${{ inputs.max_pages }}

      - name: Run Novus scraper
        if: ${{ inputs.site == 'novus' || inputs.site == 'all' }}
        run: |
          mkdir -p data
          python scripts/run_scraper.py --site novus --db data/listings.db --max-pages ${{ inputs.max_pages }}

      - name: Export data and log progress
        run: |
          if [ "${{ inputs.site }}" = "fora" ] || [ "${{ inputs.site }}" = "all" ]; then
            python scripts/analyze.py --db data/listings.db --site fora --export-excel data/fora_listings.xlsx
            python scripts/monitor.py --db data/listings.db --site fora --log-progress
          fi
          if [ "${{ inputs.site }}" = "novus" ] || [ "${{ inputs.site }}" = "all" ]; then
            python scripts/analyze.py --db data/listings.db --site novus --export-excel data/novus_listings.xlsx
            python scripts/monitor.py --db data/listings.db --site novus --log-progress
          fi

      - name: Commit scraped data
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add data/*
          git diff-index --quiet HEAD || git commit -m 'Manual scrape: ${{ inputs.site }} (max pages: ${{ inputs.max_pages }})'
          git push
